<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tommy's Music Space</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
    <div class="container">
        <div class="profile-header">
            <img src="images/profile.jpg" alt="프로필 사진" class="profile-picture">
            <div class="header-text-content">
                <h1>Tommy's Music Space</h1>
                <p class="intro-text">이곳은 Tommy의 음악을 나누는 공간입니다. 방문을 환영합니다!</p>
            </div>
        </div>
        
        <hr class="section-divider">
        
       <h2 class="section-title">나만의 플레이리스트</h2>
       <div class="playlist-controls">
            <input type="text" id="new-playlist-name" placeholder="새 플레이리스트 이름">
            <button id="create-playlist-btn" class="btn btn-add">생성</button>
        </div>
        <ul class="song-list" id="my-playlist"></ul>
        
        <hr class="section-divider">
        
        <h2 class="section-title">음악 목록</h2>
        <ul class="song-list" id="main-song-list"></ul>
    </div>

    <audio id="music-player" controls></audio>
    
  <div style="text-align: center; margin-top: 50px; margin-bottom: 20px;">
        <a href="admin.html" style="color: #888; font-size: 0.9em;">관리자 페이지로 이동</a>
    </div>  

  <script>
    // index.html <script> 태그 상단
    let activePlaylistId = null; // 현재 선택된 플레이리스트 ID를 저장
    // --- 1. 전역 변수 ---
    let myPlaylistData = [];

    const player = document.getElementById('music-player');
    const mainSongListElement = document.getElementById('main-song-list');
    const myPlaylistElement = document.getElementById('my-playlist');
    const createPlaylistBtn = document.getElementById('create-playlist-btn');
    const newPlaylistNameInput = document.getElementById('new-playlist-name');

    // --- 2. 핵심 함수들 ---
    function savePlaylist() { /* ... (기존과 동일) ... */ }
    function loadPlaylist() { /* ... (기존과 동일) ... */ }
   function renderMainList(songsData) {
    
    mainSongListElement.innerHTML = '';
    songsData.forEach(song => {
        const listItem = document.createElement('li');
        listItem.innerHTML = `
            <div class="song-item-content">
                <a href="#" class="play-link" data-src="${song.src}">
                    <div class="song-info">
                        <span class="song-title">${song.title}</span>
                        <span class="song-meta">${song.artist} | ${song.composer} | ${song.date}</span>
                    </div>
                </a>
            </div>
            <button class="btn btn-add" data-song-id="${song.id}">추가</button>
        `;
        mainSongListElement.appendChild(listItem);
    });
}
    
    // 이전에 추가했던 renderPlaylist() 함수는 삭제하거나, 아래처럼 수정합니다.
    function renderPlaylist() {
        myPlaylistElement.innerHTML = '';
        if (myPlaylistData.length === 0) return;
        myPlaylistData.forEach(song => { /* ... (기존과 동일) ... */ });
    }

    // 새로 추가한 플레이리스트 목록 렌더링 함수
    async function renderPlaylists() {
    try {
        const response = await fetch('/api/playlists');
        const playlists = await response.json();
        
        myPlaylistElement.innerHTML = '';
        playlists.forEach(playlist => {
            const listItem = document.createElement('li');
            // 각 플레이리스트를 a 태그로 만들고, data-id 속성에 고유 id를 저장
            listItem.innerHTML = `<a href="#" class="playlist-link" data-id="${playlist.id}">${playlist.name}</a>`;
            myPlaylistElement.appendChild(listItem);
        });
    } catch (error) {
        console.error("플레이리스트를 불러오는 중 오류 발생:", error);
    }
}

async function fetchAllSongs() {
    try {
        const response = await fetch('/api/songs');
        const songsData = await response.json();

        renderMainList(songsData);
        setupEventListeners(songsData);
    } catch (error) {
        console.error("노래 목록을 가져오는 데 실패했습니다:", error);
    }
}

    // --- 3. 이벤트 리스너 설정 함수 ---
    function setupEventListeners(songsData) {

    // 1. '노래 추가' 버튼 클릭 이벤트 (수정됨)
    // index.html의 '노래 추가' 이벤트 리스너 부분을 아래 코드로 교체

mainSongListElement.addEventListener('click', async function(event) {
    if (event.target.matches('.btn-add')) {
        const songId = event.target.dataset.songId;

        // --- 디버깅 코드 추가 ---
        console.log("선택된 플레이리스트 ID:", activePlaylistId);
        console.log("추가하려는 노래 ID:", songId);
        // --------------------

        if (!activePlaylistId) {
            alert('노래를 추가할 플레이리스트를 먼저 선택해주세요.');
            return;
        }
        
        try {
            const response = await fetch(`/api/playlists/${activePlaylistId}/songs`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ songId: songId })
            });

            if (response.ok) {
                alert('플레이리스트에 노래가 추가되었습니다.');
            } else {
                alert('노래 추가에 실패했습니다.');
            }
        } catch (error) {
            console.error('플레이리스트에 노래 추가 오류:', error);
        }
    }
});

    // 2. '플레이리스트' 이름 클릭 이벤트 (새로 추가됨)
    myPlaylistElement.addEventListener('click', function(event) {
        const playlistLink = event.target.closest('.playlist-link');
        if (playlistLink) {
            event.preventDefault();
            
            // 모든 링크에서 'active' 스타일 제거
            document.querySelectorAll('.playlist-link').forEach(link => link.classList.remove('active'));
            
            // 지금 클릭한 링크에만 'active' 스타일 추가
            playlistLink.classList.add('active');
            
            // 활성화된 플레이리스트 ID를 전역 변수에 저장
            activePlaylistId = playlistLink.dataset.id;
        }
    });

    // 3. '노래 재생' 클릭 이벤트 (그대로 둠)
    const container = document.querySelector('.container');
    container.addEventListener('click', function(event) {
        const playLink = event.target.closest('a.play-link');
        if (playLink) {
            event.preventDefault();
            document.querySelectorAll('.song-list li').forEach(item => item.classList.remove('playing'));
            playLink.closest('li').classList.add('playing');
            player.src = playLink.dataset.src;
            player.play();
        }
    });

    // 4. '플레이리스트 생성' 클릭 이벤트 (그대로 둠)
    createPlaylistBtn.addEventListener('click', async () => {
        const name = newPlaylistNameInput.value;
        if (!name) {
            alert('플레이리스트 이름을 입력해주세요.');
            return;
        }

        try {
            const response = await fetch('/api/playlists', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: name })
            });

            if (response.ok) {
                newPlaylistNameInput.value = ''; 
                renderPlaylists(); 
            } else {
                alert('플레이리스트 생성에 실패했습니다.');
            }
        } catch (error) {
            console.error('플레이리스트 생성 오류:', error);
        }
    });
}

    // --- 4. 초기 실행 ---
    renderPlaylists();
    fetchAllSongs();

</script>
</body>
</html>