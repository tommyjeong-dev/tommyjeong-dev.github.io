<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tommy's Music Space</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
    <div class="container">
        <div class="profile-header">
            <img src="images/profile.jpg" alt="프로필 사진" class="profile-picture">
            <div class="header-text-content">
                <h1>Tommy's Music Space</h1>
                <p class="intro-text">이곳은 Tommy의 음악을 나누는 공간입니다. 방문을 환영합니다!</p>
            </div>
        </div>
        
        <hr class="section-divider">
        
        <h2 class="section-title">나만의 플레이리스트</h2>
        <div class="playlist-controls">
            <input type="text" id="new-playlist-name" placeholder="새 플레이리스트 이름">
            <button id="create-playlist-btn" class="btn btn-add">생성</button>
        </div>
        <ul class="song-list" id="my-playlist"></ul>
        <div id="playlist-details"></div>
        
        <hr class="section-divider">
        
        <h2 class="section-title">음악 목록</h2>
        <ul class="song-list" id="main-song-list"></ul>
    </div>

    <audio id="music-player" controls></audio>
    
    <div style="text-align: center; margin-top: 50px; margin-bottom: 20px;">
        <a href="admin.html" style="color: #888; font-size: 0.9em;">관리자 페이지로 이동</a>
    </div>
<div id="lyrics-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn">&times;</button>
            <h3 id="modal-song-title"></h3>
            <pre id="modal-lyrics-content"></pre>
        </div>
    </div>


<script>
    // --- 1. 전역 변수 ---
    let activePlaylistId = null;

    const player = document.getElementById('music-player');
    const mainSongListElement = document.getElementById('main-song-list');
    const myPlaylistElement = document.getElementById('my-playlist');
    const createPlaylistBtn = document.getElementById('create-playlist-btn');
    const newPlaylistNameInput = document.getElementById('new-playlist-name');
    const detailsContainer = document.getElementById('playlist-details');
    const container = document.querySelector('.container');
    const modal = document.getElementById('lyrics-modal');

    // --- 2. 렌더링 함수 (화면 그리기) ---
    function renderMainList(songsData) {
        mainSongListElement.innerHTML = '';
        songsData.forEach(song => {
            const listItem = document.createElement('li');
            listItem.innerHTML = `
                <a href="#" class="play-link" data-src="${song.src}">
                    <div class="song-info">
                        <span class="song-title">${song.title}</span>
                        <span class="song-meta">${song.artist} | ${song.composer} | ${song.date}</span>
                    </div>
                </a>
                <div class="buttons">
                    <button class="btn btn-lyrics" data-song-id="${song.id}">가사</button>
                    <button class="btn btn-add" data-song-id="${song.id}">추가</button>
                </div>
            `;
            mainSongListElement.appendChild(listItem);
        });
    }

    function renderPlaylists(playlists) {
        myPlaylistElement.innerHTML = '';
        playlists.forEach(playlist => {
            const listItem = document.createElement('li');
            const link = document.createElement('a');
            link.href = '#';
            link.className = 'playlist-link';
            link.dataset.id = playlist.id;
            link.textContent = playlist.name;
            if (playlist.id == activePlaylistId) { // ==를 사용하여 문자열과 숫자 비교
                link.classList.add('active');
            }
            listItem.appendChild(link);
            myPlaylistElement.appendChild(listItem);
        });
    }

    function renderPlaylistDetails(playlist) {
        detailsContainer.innerHTML = '';
        const titleElement = document.createElement('h3');
        titleElement.textContent = `[${playlist.name}] 수록곡`;
        detailsContainer.appendChild(titleElement);

        const songsUl = document.createElement('ul');
        songsUl.className = 'song-list';

        if (playlist.Songs && playlist.Songs.length > 0) {
            playlist.Songs.forEach(song => {
                const songLi = document.createElement('li');
                songLi.innerHTML = `
                    <a href="#" class="play-link" data-src="${song.src}">
                        <div class="song-info">
                            <span class="song-title">${song.title}</span>
                            <span class="song-meta">${song.artist} | ${song.composer}</span>
                        </div>
                    </a>
                    <button class="btn btn-delete" data-song-id="${song.id}">삭제</button>
                `;
                songsUl.appendChild(songLi);
            });
        } else {
            songsUl.innerHTML = '<li>담긴 노래가 없습니다.</li>';
        }
        detailsContainer.appendChild(songsUl);
    }

    // --- 3. 데이터 통신 함수 (서버와 대화) ---
    async function fetchAllSongs() {
        try {
            const response = await fetch('/api/songs');
            return await response.json();
        } catch (error) {
            console.error("노래 목록을 가져오는 데 실패했습니다:", error);
            return [];
        }
    }

    async function fetchPlaylists() {
        try {
            const response = await fetch('/api/playlists');
            return await response.json();
        } catch (error) {
            console.error("플레이리스트를 불러오는 중 오류 발생:", error);
            return [];
        }
    }

    // --- 4. 이벤트 처리 ---
    function setupEventListeners(songsData) {
        // [개선] 여러 이벤트 리스너를 하나로 통합하여 효율적으로 관리
        container.addEventListener('click', async function(event) {
            const target = event.target;

            // 노래 재생 (a.play-link)
            const playLink = target.closest('a.play-link');
            if (playLink) {
                event.preventDefault();
                document.querySelectorAll('.song-list li').forEach(item => item.classList.remove('playing'));
                playLink.closest('li').classList.add('playing');
                player.src = playLink.dataset.src;
                player.play();
                return;
            }

            // 플레이리스트 선택 (.playlist-link)
            const playlistLink = target.closest('.playlist-link');
            if (playlistLink) {
                event.preventDefault();
                const isAlreadyActive = playlistLink.classList.contains('active');
                document.querySelectorAll('.playlist-link').forEach(link => link.classList.remove('active'));

                if (isAlreadyActive) {
                    activePlaylistId = null;
                    detailsContainer.innerHTML = '';
                } else {
                    playlistLink.classList.add('active');
                    activePlaylistId = playlistLink.dataset.id;
                    const response = await fetch(`/api/playlists/${activePlaylistId}`);
                    const playlist = await response.json();
                    renderPlaylistDetails(playlist);
                }
                return;
            }
            
            // 가사 버튼 클릭 (.btn-lyrics)
            if (target.matches('.btn-lyrics')) {
                const songId = target.dataset.songId;
                try {
                    const response = await fetch(`/api/songs/${songId}`);
                    const song = await response.json();
                    document.getElementById('modal-song-title').textContent = song.title;
                    document.getElementById('modal-lyrics-content').textContent = song.lyrics || "가사 정보가 없습니다.";
                    modal.classList.add('visible');
                } catch (error) {
                    console.error("가사를 불러오는 중 오류 발생:", error);
                }
                return;
            }

            // 노래 추가 버튼 클릭 (.btn-add)
            if (target.matches('.btn-add')) {
                if (!activePlaylistId) {
                    alert('노래를 추가할 플레이리스트를 먼저 선택해주세요.');
                    return;
                }
                const songId = target.dataset.songId;
                try {
                    const response = await fetch(`/api/playlists/${activePlaylistId}/songs`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ songId: songId })
                    });
                    if (response.ok) {
                        alert('플레이리스트에 노래가 추가되었습니다.');
                        const updatedPlaylist = await (await fetch(`/api/playlists/${activePlaylistId}`)).json();
                        renderPlaylistDetails(updatedPlaylist);
                    } else {
                        alert('노래 추가에 실패했습니다.');
                    }
                } catch (error) { console.error('플레이리스트에 노래 추가 오류:', error); }
                return;
            }

            // 플레이리스트에서 노래 삭제 버튼 클릭 (.btn-delete)
            if (target.matches('.btn-delete')) {
                const songId = target.dataset.songId;
                if (confirm('정말로 이 노래를 플레이리스트에서 삭제하시겠습니까?')) {
                    try {
                        const response = await fetch(`/api/playlists/${activePlaylistId}/songs/${songId}`, {
                            method: 'DELETE'
                        });
                        if (response.ok) {
                            const updatedPlaylist = await (await fetch(`/api/playlists/${activePlaylistId}`)).json();
                            renderPlaylistDetails(updatedPlaylist);
                        } else {
                            alert('삭제에 실패했습니다.');
                        }
                    } catch (error) { console.error('삭제 오류:', error); }
                }
                return;
            }
        });

        // 플레이리스트 생성 버튼
        createPlaylistBtn.addEventListener('click', async () => {
            const name = newPlaylistNameInput.value;
            if (!name) {
                alert('플레이리스트 이름을 입력해주세요.');
                return;
            }
            try {
                const response = await fetch('/api/playlists', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name })
                });
                if (response.ok) {
                    newPlaylistNameInput.value = '';
                    const playlists = await fetchPlaylists();
                    renderPlaylists(playlists);
                } else {
                    alert('플레이리스트 생성에 실패했습니다.');
                }
            } catch (error) { console.error('플레이리스트 생성 오류:', error); }
        });

        // 가사 모달 닫기
        modal.addEventListener('click', function(event) {
            if (event.target.matches('.close-btn') || event.target === modal) {
                modal.classList.remove('visible');
            }
        });
    }

    // --- 5. 초기 실행 ---
    async function init() {
        const playlists = await fetchPlaylists();
        renderPlaylists(playlists);

        const songsData = await fetchAllSongs();
        renderMainList(songsData);
        
        setupEventListeners(songsData);
    }

    init();
</script>
</body>
</html>