<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tommy's Music Space</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
    <div class="container">
        <div class="profile-header">
            <img src="images/profile.jpg" alt="프로필 사진" class="profile-picture">
            <div class="header-text-content">
                <h1>Tommy's Music Space</h1>
                <p class="intro-text">이곳은 Tommy의 음악을 나누는 공간입니다. 방문을 환영합니다!</p>
            </div>
        </div>
        
        <hr class="section-divider">
        
       <h2 class="section-title">나만의 플레이리스트</h2>
       <div class="playlist-controls">
            <input type="text" id="new-playlist-name" placeholder="새 플레이리스트 이름">
            <button id="create-playlist-btn" class="btn btn-add">생성</button>
        </div>
        <ul class="song-list" id="my-playlist"></ul>
        
        <hr class="section-divider">
        
        <h2 class="section-title">음악 목록</h2>
        <ul class="song-list" id="main-song-list"></ul>
    </div>

    <audio id="music-player" controls></audio>
    
  <div style="text-align: center; margin-top: 50px; margin-bottom: 20px;">
        <a href="admin.html" style="color: #888; font-size: 0.9em;">관리자 페이지로 이동</a>
    </div>  

  <script>
    // --- 1. 전역 변수 ---
    let myPlaylistData = [];

    const player = document.getElementById('music-player');
    const mainSongListElement = document.getElementById('main-song-list');
    const myPlaylistElement = document.getElementById('my-playlist');
    const createPlaylistBtn = document.getElementById('create-playlist-btn');
    const newPlaylistNameInput = document.getElementById('new-playlist-name');

    // --- 2. 핵심 함수들 ---
    function savePlaylist() { /* ... (기존과 동일) ... */ }
    function loadPlaylist() { /* ... (기존과 동일) ... */ }
    function renderMainList(songsData) { /* ... (기존과 동일) ... */ }
    
    // 이전에 추가했던 renderPlaylist() 함수는 삭제하거나, 아래처럼 수정합니다.
    function renderPlaylist() {
        myPlaylistElement.innerHTML = '';
        if (myPlaylistData.length === 0) return;
        myPlaylistData.forEach(song => { /* ... (기존과 동일) ... */ });
    }

    // 새로 추가한 플레이리스트 목록 렌더링 함수
    async function renderPlaylists() {
        try {
            const response = await fetch('/api/playlists');
            const playlists = await response.json();
            
            myPlaylistElement.innerHTML = ''; 
            playlists.forEach(playlist => {
                const listItem = document.createElement('li');
                listItem.textContent = playlist.name;
                myPlaylistElement.appendChild(listItem);
            });

        } catch (error) {
            console.error("플레이리스트를 불러오는 중 오류 발생:", error);
        }
    }

    async function fetchAllSongs() {
    try {
        const response = await fetch('/api/songs');
        const songsData = await response.json();
        renderMainList(songsData);
        setupEventListeners(songsData); // <-- 이 줄이 반드시 있어야 합니다.
    } catch (error) {
        console.error("노래 목록을 가져오는 데 실패했습니다:", error);
    }
}

    // --- 3. 이벤트 리스너 설정 함수 ---
    function setupEventListeners(songsData) {
        mainSongListElement.addEventListener('click', function(event) { /* ... (기존과 동일) ... */ });
        const container = document.querySelector('.container');
        container.addEventListener('click', function(event) { /* ... (기존과 동일) ... */ });
        myPlaylistElement.addEventListener('click', function(event) { /* ... (기존과 동일) ... */ });

        // '생성' 버튼 이벤트 리스너를 이곳으로 이동
        createPlaylistBtn.addEventListener('click', async () => {
            console.log('생성 버튼이 클릭되었습니다!'); // <-- 이 줄을 추가해주세요!
            const name = newPlaylistNameInput.value;
            if (!name) {
                alert('플레이리스트 이름을 입력해주세요.');
                return;
            }

            try {
                const response = await fetch('/api/playlists', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name })
                });

                if (response.ok) {
                    newPlaylistNameInput.value = ''; 
                    renderPlaylists(); // 목록 새로고침
                } else {
                    alert('플레이리스트 생성에 실패했습니다.');
                }
            } catch (error) {
                console.error('플레이리스트 생성 오류:', error);
            }
        });
    }

    // --- 4. 초기 실행 ---
    renderPlaylists();
    fetchAllSongs();

</script>
</body>
</html>